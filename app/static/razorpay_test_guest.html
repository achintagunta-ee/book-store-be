<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Guest Checkout ‚Äì Razorpay Test</title>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 40px auto;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        pre {
            background: #f4f4f4;
            padding: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<h2>üìö Guest Checkout (Razorpay Test)</h2>

<button onclick="startCheckout()">üí≥ Pay Now</button>

<pre id="output">Click "Pay Now" to start checkout</pre>

<script>
const API_BASE = "https://hbn-be.efficientemengineering.com/checkout/guest";

async function startCheckout() {
    const output = document.getElementById("output");
    output.innerText = "üõí Creating guest order...";

    try {
        const res = await fetch(`${API_BASE}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                guest: {
                    name: "Guest User",
                    email: "guest@test.com",
                    phone: "9999999999"
                },
                address: {
                    line1: "Street 1",
                    line2: "",
                    city: "Hyderabad",
                    state: "Telangana",
                    pincode: "500001"
                },
                items: [{ book_id: 1, quantity: 1 }]
            })
        });

        const data = await res.json();
        output.innerText = "‚úÖ Order Created:\n" + JSON.stringify(data, null, 2);

        const options = {
            key: data.razorpay_key,
            amount: Math.round(data.amount * 100),
            currency: "INR",
            name: "Hithabodha Bookstore",
            description: "Guest Checkout",
            order_id: data.razorpay_order_id,

            handler: function (response) {
                output.innerText =
                    "üéâ Razorpay Payment Success:\n" +
                    JSON.stringify(response, null, 2);

                verifyPayment(data.order_id, response);
            },

            prefill: {
                name: data.guest_name,
                email: data.guest_email,
                contact: "9999999999"
            }
        };

        new Razorpay(options).open();

    } catch (err) {
        output.innerText = "‚ùå Error: " + err.message;
    }
}

async function verifyPayment(orderId, response) {
    const output = document.getElementById("output");

    const res = await fetch(`${API_BASE}/verify-payment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            order_id: orderId,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_order_id: response.razorpay_order_id,
            razorpay_signature: response.razorpay_signature
        })
    });

    const result = await res.json();
    output.innerText += "\n\n‚úÖ Backend Verification:\n" +
        JSON.stringify(result, null, 2);
}
</script>

</body>
</html>
