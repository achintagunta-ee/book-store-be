<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Buy Now ‚Äì Razorpay Test (Local)</title>

    <!-- Razorpay SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 40px auto;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        pre {
            background: #f4f4f4;
            padding: 12px;
            margin-top: 20px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

<h2>‚ö° Buy Now Checkout (Razorpay Test ‚Äì Local)</h2>

<button onclick="startBuyNow()">üí≥ Pay Now</button>

<pre id="output">Click "Pay Now"</pre>

<script>
/**
 * ‚úÖ LOCAL API BASE
 */
const API_BASE = "http://localhost:8000/book";

/**
 * üîê LOCAL USER JWT TOKEN
 * Generate this from localhost login
 */
const USER_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJleHAiOjE3NzM1NzUwOTd9.Jgg8851KfTi4kQ8fMvbn4UYQzKCMEqTfTG1hh535MOI";

async function startBuyNow() {
    const output = document.getElementById("output");
    output.innerText = "üõí Creating Buy Now order...";

    try {
        const res = await fetch(`${API_BASE}/buy-now`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${USER_TOKEN}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                book_id: 1,      // üîÅ change if needed
                quantity: 1,
                address_id: 2    // üîÅ valid local address ID
            })
        });

        if (!res.ok) {
            const errText = await res.text();
            throw new Error(errText);
        }

        const data = await res.json();
        console.log("Buy Now response:", data);

        output.innerText =
            "‚úÖ Order Created\n\n" +
            JSON.stringify(data, null, 2);

        const options = {
            key: data.razorpay_key,
            amount: Math.round(data.amount * 100), // rupees ‚Üí paise
            currency: "INR",
            name: "Hithabodha Bookstore",
            description: "Buy Now Purchase",
            order_id: data.razorpay_order_id,

            handler: function (response) {
                output.innerText =
                    "üéâ Razorpay Payment Success\n\n" +
                    JSON.stringify(response, null, 2);

                verifyBuyNowPayment(data.order_id, response);
            },

            prefill: {
                name: data.user_name,
                email: data.user_email
            },

            theme: {
                color: "#3399cc"
            }
        };

        new Razorpay(options).open();

    } catch (err) {
        console.error(err);
        output.innerText = "‚ùå Error: " + err.message;
    }
}

async function verifyBuyNowPayment(orderId, response) {
    const output = document.getElementById("output");

    try {
        const res = await fetch(`${API_BASE}/buy-now/verify-payment`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${USER_TOKEN}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                order_id: orderId,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature
            })
        });

        if (!res.ok) {
            const errText = await res.text();
            throw new Error(errText);
        }

        const result = await res.json();

        output.innerText +=
            "\n\n‚úÖ Backend Verification Success\n\n" +
            JSON.stringify(result, null, 2);

    } catch (err) {
        console.error(err);
        output.innerText += "\n\n‚ùå Verification failed: " + err.message;
    }
}
</script>

</body>
</html>
