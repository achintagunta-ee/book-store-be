<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Checkout ‚Äì Razorpay Test</title>

    <!-- Razorpay SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 40px auto;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        pre {
            background: #f4f4f4;
            padding: 12px;
            margin-top: 20px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

<h2>üìö User Checkout (Razorpay Test)</h2>

<button onclick="startCheckout()">üí≥ Pay Now</button>

<pre id="output">Click "Pay Now" to start checkout</pre>

<script>
const API_BASE = "https://hbn-be.efficientemengineering.com/checkout";

/**
 * Replace with your actual USER JWT token
 */
const USER_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJleHAiOjE3NzA0NTM2Nzl9.hrqpkyFV7C0umthyUfiuQVuN4gCoj_-F7NWCLsb5Wrg";

async function startCheckout() {
    const output = document.getElementById("output");
    output.innerText = "üõí Creating Razorpay order...";

    try {
        const res = await fetch(
            `${API_BASE}/create-razorpay-order?address_id=3`,
            {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${USER_TOKEN}`,
                    "Content-Type": "application/json"
                }
            }
        );

        if (!res.ok) {
            throw new Error("Failed to create Razorpay order");
        }

        const data = await res.json();
        console.log("Create order response:", data);

        output.innerText = "‚úÖ Order Created:\n" + JSON.stringify(data, null, 2);

        const options = {
            key: data.razorpay_key,              // ‚úÖ Changed from key_id
            amount: Math.round(data.amount * 100), // ‚úÖ Changed from amount_paise
            currency: "INR",
            name: "Hithabodha Bookstore",
            description: "User Checkout",
            order_id: data.razorpay_order_id,

            handler: function (response) {
                output.innerText =
                    "üéâ Razorpay Payment Success:\n" +
                    JSON.stringify(response, null, 2);

                verifyPayment(data.order_id, response);
            },

            prefill: {
                name: data.user_name,
                email: data.user_email,
            },

            theme: {
                color: "#3399cc"
            }
        };

        new Razorpay(options).open();

    } catch (err) {
        console.error(err);
        output.innerText = "‚ùå Error: " + err.message;
    }
}

async function verifyPayment(orderId, response) {
    const output = document.getElementById("output");

    try {
        const res = await fetch(`${API_BASE}/verify-razorpay-payment`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${USER_TOKEN}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                order_id: orderId,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature
            })
        });

        const result = await res.json();

        output.innerText +=
            "\n\n‚úÖ Backend Verification:\n" +
            JSON.stringify(result, null, 2);

    } catch (err) {
        console.error(err);
        output.innerText += "\n\n‚ùå Verification failed: " + err.message;
    }
}
</script>

</body>
</html>
