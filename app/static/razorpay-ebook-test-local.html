<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Razorpay eBook Test</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>üìò Razorpay eBook Payment Test</h2>

  <p>
    <b>Purchase ID:</b>
    <input id="purchaseId" value="1" />
  </p>

  <p>
    <b>JWT Token:</b><br/>
    <textarea id="token" rows="4" cols="80"
      placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJleHAiOjE3NzE0NzAzMzB9.D4P2_5eqTXh0Y2K1If43BJoM3ysyPtb1u5w3bSlfK6s"></textarea>
  </p>

  <button onclick="startPayment()">Pay with Razorpay</button>

  <pre id="output"></pre>

  <script>
async function startPayment() {
  const purchaseId = document.getElementById("purchaseId").value;
  const token = document.getElementById("token").value;

  if (!purchaseId || !token) {
    alert("Purchase ID and token required");
    return;
  }

  try {
    // 1Ô∏è‚É£ Create Razorpay Order
    const orderRes = await fetch(
      `http://localhost:8000/ebooks/${purchaseId}/create-razorpay-order`,
      {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        }
      }
    );

    if (!orderRes.ok) {
      const errorText = await orderRes.text();
      console.error("Order creation failed:", errorText);
      alert(`Order creation failed: ${orderRes.status}`);
      return;
    }

    const orderData = await orderRes.json();
    console.log("Order created:", orderData);

    // 2Ô∏è‚É£ Open Razorpay Checkout
    const options = {
      key: orderData.razorpay_key,
      amount: orderData.amount * 100,
      currency: "INR",
      name: "Hithabodha",
      description: "eBook Purchase",
      order_id: orderData.razorpay_order_id,

      handler: async function (response) {
        console.log("Payment success:", response);

        try {
          // 3Ô∏è‚É£ Verify payment
          const verifyRes = await fetch(
            `http://localhost:8000/ebooks/${purchaseId}/verify-razorpay-payment`,
            {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature
              })
            }
          );

          // ‚úÖ CHECK IF RESPONSE IS OK
          if (!verifyRes.ok) {
            const errorText = await verifyRes.text();
            console.error("‚ùå Verification failed:", errorText);
            
            // Show user-friendly message
            document.getElementById("output").innerText = 
              "‚ö†Ô∏è Payment received but verification failed.\n" +
              "Your payment is successful. Please contact support.\n\n" +
              `Error: ${verifyRes.status}`;
            return;
          }

          const verifyData = await verifyRes.json();
          console.log("‚úÖ Verify response:", verifyData);

          document.getElementById("output").innerText =
            "‚úÖ Payment Successful!\n\n" +
            JSON.stringify(verifyData, null, 2);

        } catch (err) {
          console.error("‚ùå Verification error:", err);
          document.getElementById("output").innerText =
            "‚ö†Ô∏è Payment received but verification failed.\n" +
            "Please contact support with this payment ID:\n" +
            response.razorpay_payment_id;
        }
      },

      prefill: {
        email: orderData.user_email,
        name: orderData.user_name
      },

      theme: {
        color: "#3399cc"
      }
    };

    const rzp = new Razorpay(options);
    rzp.open();

  } catch (err) {
    console.error("‚ùå Error:", err);
    alert(`Error: ${err.message}`);
  }
}
</script>

</body>
</html>
